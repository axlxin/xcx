<?xml version="1.0" encoding="utf-8"?>
<modification>
    <name>KP Order Number Rewrite</name>
    <code>kp_order_number_rewrite</code>
    <update>2016-09-21</update>
    <version>2.4.1</version>
    <author>Kevin Pan</author>

    <file path="admin/view/template/sale/order_list.tpl">
        <operation info="修改订单列表中的订单号">
            <search >
	        <![CDATA[<td class="text-right"><?php echo $order['order_id']; ?></td>]]>
            </search>
            <add position="replace"><![CDATA[
<td class="text-right"><?php echo 'SP'. str_pad($order['order_id'], 8, '0', STR_PAD_LEFT); ?></td>
]]></add>
        </operation>
    </file>

    <file path="admin/view/template/sale/order_info.tpl">
        <operation info="修改订单详情中的订单号">
            <search >
	        <![CDATA[<td>#<?php echo $order_id; ?></td>]]>
            </search>
            <add position="replace"><![CDATA[
<td>#<?php echo 'SP'. str_pad($order_id, 8, '0', STR_PAD_LEFT); ?></td>
]]></add>
        </operation>
    </file>
    
    <file path="admin/view/template/sale/order_shipping.tpl">
        <operation info="修改shipping list中的订单号">
            <search >
	        <![CDATA[<b><?php echo $text_order_id; ?></b> <?php echo $order['order_id']; ?><br />]]>
            </search>
            <add position="replace"><![CDATA[
<b><?php echo $text_order_id; ?></b> <?php echo 'SP'. str_pad($order['order_id'], 8, '0', STR_PAD_LEFT); ?><br />
]]></add>
        </operation>
    </file>
    
    <file path="admin/view/template/sale/order_invoice.tpl">
        <operation info="修改shipping list中的订单号">
            <search >
	        <![CDATA[<b><?php echo $text_order_id; ?></b> <?php echo $order['order_id']; ?><br />]]>
            </search>
            <add position="replace"><![CDATA[
<b><?php echo $text_order_id; ?></b> <?php echo 'SP'. str_pad($order['order_id'], 8, '0', STR_PAD_LEFT); ?><br />
]]></add>
        </operation>
    </file>
    
    <file path="admin/view/template/dashboard/recent.tpl">
        <operation info="修改shipping list中的订单号">
            <search >
	        <![CDATA[<td class="text-right"><?php echo $order['order_id']; ?></td>]]>
            </search>
            <add position="replace"><![CDATA[
<td class="text-right"><?php echo 'SP'. str_pad($order['order_id'], 8, '0', STR_PAD_LEFT); ?></td>
]]></add>
        </operation>
    </file>
    
    <file path="catalog/controller/payment/pp_standard.php">
        <operation info="修改PayPal Payments Standard支付方式的订单号">
            <search >
	        <![CDATA[$data['invoice'] = $this->session->data['order_id'] . ' - ' . html_entity_decode($order_info['payment_firstname'], ENT_QUOTES, 'UTF-8') . ' ' . html_entity_decode($order_info['payment_lastname'], ENT_QUOTES, 'UTF-8');]]>
            </search>
            <add position="replace"><![CDATA[
$data['invoice'] = 'SP' . str_pad($this->session->data['order_id'], 8, '0', STR_PAD_LEFT) . ' - ' . html_entity_decode($order_info['payment_firstname'], ENT_QUOTES, 'UTF-8') . ' ' . html_entity_decode($order_info['payment_lastname'], ENT_QUOTES, 'UTF-8');
]]></add>
        </operation>
    </file>
    
    <file path="admin/controller/sale/order.php">
        <operation info="修改订单详情里的附件序号_1">
            <search index='1'>
	        <![CDATA[$products = $this->model_sale_order->getOrderProducts($this->request->get['order_id']);]]>
            </search>
            <add position="after" ><![CDATA[
$products_file_index = 0;
]]></add>
        </operation>
        <operation info="修改订单详情里的附件序号_2">
            <search index='0'>
	        <![CDATA[$options = $this->model_sale_order->getOrderOptions($this->request->get['order_id'], $product['order_product_id']);]]>
            </search>
            <add position="before" ><![CDATA[
$products_file_index++;
]]></add>
        </operation>
        <operation info="修改订单详情里的附件超链接地址">
            <search >
	        <![CDATA['href'  => $this->url->link('tool/upload/download', 'token=' . $this->session->data['token'] . '&code=' . $upload_info['code'], 'SSL')]]>
            </search>
            <add position="replace" ><![CDATA[
'href'  => $this->url->link('tool/upload/download', 'token=' . $this->session->data['token'] . '&code=' . $upload_info['code'] . '&prefix=SP' . $this->request->get['order_id'] . '-' . $products_file_index, 'SSL')
]]></add>
        </operation>
    </file>
    
    <file path="admin/controller/tool/upload.php">
        <operation info="修改文件下载类的文件名字显示方式">
            <search >
	        <![CDATA[if (is_file($file)) {]]>
            </search>
            <add position="after"><![CDATA[
if (isset($this->request->get['prefix'])) {
    $prefix = $this->request->get['prefix'];
    $mask = $mask ? ($prefix . '-' . $mask) : ($prefix . '-' . basename($file));
}
]]></add>
        </operation>
    </file>
    
    <!--<file path="catalog/view/theme/journal2/template/account/order_list.tpl">
        <operation info="修改前端客户订单列表的orderid">
            <search >
	        <![CDATA[<td class="text-right">#<?php echo $order['order_id']; ?></td>]]>
            </search>
            <add position="replace"><![CDATA[
<td class="text-right">#<?php echo 'SP' . str_pad($order['order_id'], 8, '0', STR_PAD_LEFT); ?></td>
]]></add>
        </operation>
    </file>
    
    <file path="catalog/view/theme/journal2/template/account/order_info.tpl">
        <operation info="修改前端客户订单详情页的orderid">
            <search >
	        <![CDATA[<b><?php echo $text_order_id; ?></b> #<?php echo $order_id; ?><br />]]>
            </search>
            <add position="replace"><![CDATA[
<b><?php echo $text_order_id; ?></b> #<?php echo  'SP' . str_pad($order_id, 8, '0', STR_PAD_LEFT); ?><br />
]]></add>
        </operation>
    </file>-->
</modification>