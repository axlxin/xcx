<modification>
	<name>EmailOneReturn by iSenseLabs</name>
	<version>2.1</version>
	<link>http://isenselabs.com</link>
	<author>iSenseLabs</author>
	<code>isenselabs_mailonreturn</code>
	<file path="catalog/model/account/return.php">

		<operation>
			<search><![CDATA[public function addReturn($data) {]]></search>
			<add position="before"><![CDATA[
				public function getReturnReason($return_reason_id) {
					$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "return_reason WHERE return_reason_id = '" . (int)$return_reason_id . "' AND language_id = '" . (int)$this->config->get('config_language_id') . "'");

					return $query->row;
				}
				]]></add>
		</operation>


		<operation>
			<search><![CDATA[public function addReturn($data) {]]></search>
			<add position="after"><![CDATA[
				/* MailOnReturn */
				$this->load->model('localisation/return_reason');

				$return_email_subject = "New Product Return Request - " . $this->db->escape($data['firstname']) . " " . $this->db->escape($data['lastname']);
				$return_email_text = "A new product return request has been made in your store.\n\n";
				$return_email_text .= "Customer: " . $this->db->escape($data['firstname']) . " " . $this->db->escape($data['lastname']) . "\n";

				if (!empty($data['email'])) {
					$return_email_text .= 'Email: ' . $this->db->escape($data['email']) . "\n";
				}

				if (!empty($data['telephone'])) {
					$return_email_text .= 'Phone: ' . $this->db->escape($data['telephone']) . "\n\n";
				}

				$return_email_text .= 'Order ID: ' . $data['order_id'] . "\n";
				$return_email_text .= 'Date Ordered: ' . $data['date_ordered'] . "\n";
				$return_email_text .= 'Product: ' . $this->db->escape($data['product']) . "\n";
				$return_email_text .= 'Product Model: ' . $this->db->escape($data['model']) . "\n\n";


				$return_reason_info = $this->getReturnReason($data['return_reason_id']);

				if (!empty($return_reason_info['name'])) {
					$return_email_text .= 'Return Reason: ' . $this->db->escape($return_reason_info['name']) . "\n";
				}

				if (!empty($data['comment'])) {
					$return_email_text .= 'Comment: ' . $this->db->escape($data['comment']) . "\n\n";
				}

				$return_email_text .= 'You can review the order return from your OpenCart administration';

				if (VERSION < '2.0.2.0' || VERSION == '2.0.3.1') {
					$mail = new Mail($this->config->get('config_mail'));
				} else {
					$mail = new Mail();
					$mail->protocol = $this->config->get('config_mail_protocol');
					$mail->parameter = $this->config->get('config_mail_parameter');
					$mail->smtp_hostname = $this->config->get('config_mail_smtp_hostname');
					$mail->smtp_username = $this->config->get('config_mail_smtp_username');
					$mail->smtp_password = html_entity_decode($this->config->get('config_mail_smtp_password'), ENT_QUOTES, 'UTF-8');
					$mail->smtp_port = $this->config->get('config_mail_smtp_port');
					$mail->smtp_timeout = $this->config->get('config_mail_smtp_timeout');
				}
				$mail->setTo($this->config->get('config_email'));
				$mail->setFrom($this->config->get('config_email'));
				$mail->setSender($this->config->get('config_name'));
				$mail->setSubject(html_entity_decode($return_email_subject, ENT_QUOTES, 'UTF-8'));
				$mail->setText(html_entity_decode($return_email_text, ENT_QUOTES, 'UTF-8'));
				$mail->send();
				/* End MailOnReturn */
			]]></add>
		</operation>
	</file>
</modification>